{"ast":null,"code":"import _extends from \"D:/dev/cardclan-backend/template-tool/node_modules/@babel/runtime/helpers/esm/extends\";\nimport _objectSpread from \"D:/dev/cardclan-backend/template-tool/node_modules/@babel/runtime/helpers/esm/objectSpread2\";\n\nvar _jsxFileName = \"D:\\\\dev\\\\cardclan-backend\\\\template-tool\\\\src\\\\components\\\\DesignTool\\\\MainStage\\\\index.tsx\",\n    _this = this;\n\nvar __jsx = React.createElement;\nimport React, { useRef, useState } from 'react';\nimport { Stage, Layer, Rect } from 'react-konva';\nimport Rectangle from \"../Rectangle\";\nimport UCircle from \"../UCircle\";\nimport UPolygon from \"../UPolygon\";\nimport ULine from \"../ULine\";\nimport USvg from \"../USvg\";\nimport UText from \"../UText\";\nimport TransformerComponent from \"../UTransformer\";\nimport { stageDimensions } from '../../../utils/defaults';\nimport UImage from '../UImage';\n\nvar MainStage = function MainStage(_ref) {\n  var _templateData$variati, _templateData$variati2, _templateData$variati3, _templateData$variati4, _templateData$variati5, _templateData$variati6, _templateData$variati7, _templateData$variati8, _templateData$variati9, _templateData$variati10, _templateData$variati11;\n\n  var templateData = _ref.templateData,\n      setTemplateData = _ref.setTemplateData,\n      variationIndex = _ref.variationIndex,\n      selectedId = _ref.selectedId,\n      setSelectedId = _ref.setSelectedId,\n      unSelectAll = _ref.unSelectAll,\n      handleEditSelectedItem = _ref.handleEditSelectedItem;\n  var GUIDELINE_OFFSET = 5;\n  var $stage = useRef(null);\n  var $layer = useRef(null);\n  var $tr = useRef(null);\n  var selectionRectRef = useRef(null);\n  var selection = useRef({\n    visible: false,\n    x1: 0,\n    y1: 0,\n    x2: 0,\n    y2: 0\n  });\n\n  var _useState = useState([]),\n      nodesArray = _useState[0],\n      setNodes = _useState[1];\n\n  var Konva = window.Konva;\n\n  var getLineGuideStops = function getLineGuideStops(skipShape) {\n    var vertical = [0, stageDimensions.width / 2, stageDimensions.width];\n    var horizontal = [0, stageDimensions.height / 2, stageDimensions.height]; // and we snap over edges and center of each object on the canvas\n\n    $stage.current.find(\".object\").forEach(function (guideItem) {\n      if (guideItem === skipShape) {\n        return;\n      }\n\n      var box = guideItem.getClientRect(); // and we can snap to all edges of shapes\n\n      vertical.push([box.x, box.x + box.width, box.x + box.width / 2]);\n      horizontal.push([box.y, box.y + box.height, box.y + box.height / 2]);\n    });\n    return {\n      vertical: vertical.flat(),\n      horizontal: horizontal.flat()\n    };\n  };\n\n  var getObjectSnappingEdges = function getObjectSnappingEdges(node) {\n    var box = node.getClientRect();\n    return {\n      vertical: [{\n        guide: Math.round(box.x),\n        offset: Math.round(node.x() - box.x),\n        snap: \"start\"\n      }, {\n        guide: Math.round(box.x + box.width / 2),\n        offset: Math.round(node.x() - box.x - box.width / 2),\n        snap: \"center\"\n      }, {\n        guide: Math.round(box.x + box.width),\n        offset: Math.round(node.x() - box.x - box.width),\n        snap: \"end\"\n      }],\n      horizontal: [{\n        guide: Math.round(box.y),\n        offset: Math.round(node.y() - box.y),\n        snap: \"start\"\n      }, {\n        guide: Math.round(box.y + box.height / 2),\n        offset: Math.round(node.y() - box.y - box.height / 2),\n        snap: \"center\"\n      }, {\n        guide: Math.round(box.y + box.height),\n        offset: Math.round(node.y() - box.y - box.height),\n        snap: \"end\"\n      }]\n    };\n  };\n\n  var getGuides = function getGuides(lineGuideStops, itemBounds) {\n    var resultV = [];\n    var resultH = [];\n    lineGuideStops.vertical.forEach(function (lineGuide) {\n      itemBounds.vertical.forEach(function (itemBound) {\n        var diff = Math.abs(lineGuide - itemBound.guide); // if the distance between guild line and object snap point is close we can consider this for snapping\n\n        if (diff < GUIDELINE_OFFSET) {\n          resultV.push({\n            lineGuide: lineGuide,\n            diff: diff,\n            snap: itemBound.snap,\n            offset: itemBound.offset\n          });\n        }\n      });\n    });\n    lineGuideStops.horizontal.forEach(function (lineGuide) {\n      itemBounds.horizontal.forEach(function (itemBound) {\n        var diff = Math.abs(lineGuide - itemBound.guide);\n\n        if (diff < GUIDELINE_OFFSET) {\n          resultH.push({\n            lineGuide: lineGuide,\n            diff: diff,\n            snap: itemBound.snap,\n            offset: itemBound.offset\n          });\n        }\n      });\n    });\n    var guides = []; // find closest snap\n\n    var minV = resultV.sort(function (a, b) {\n      return a.diff - b.diff;\n    })[0];\n    var minH = resultH.sort(function (a, b) {\n      return a.diff - b.diff;\n    })[0];\n\n    if (minV) {\n      guides.push({\n        lineGuide: minV.lineGuide,\n        offset: minV.offset,\n        orientation: \"V\",\n        snap: minV.snap\n      });\n    }\n\n    if (minH) {\n      guides.push({\n        lineGuide: minH.lineGuide,\n        offset: minH.offset,\n        orientation: \"H\",\n        snap: minH.snap\n      });\n    }\n\n    return guides;\n  };\n\n  var drawGuides = function drawGuides(guides) {\n    guides.forEach(function (lg) {\n      if (lg.orientation === \"H\") {\n        var lines = new Konva.Line({\n          points: [-6000, lg.lineGuide, 6000, lg.lineGuide],\n          stroke: \"rgb(0, 161, 255)\",\n          strokeWidth: 1,\n          name: \"guid-line\",\n          dash: [4, 6]\n        });\n        $layer.current.add(lines);\n        $layer.current.batchDraw();\n      } else if (lg.orientation === \"V\") {\n        var _lines = new Konva.Line({\n          points: [lg.lineGuide, -6000, lg.lineGuide, 6000],\n          stroke: \"rgb(0, 161, 255)\",\n          strokeWidth: 1,\n          name: \"guid-line\",\n          dash: [4, 6]\n        });\n\n        $layer.current.add(_lines);\n        $layer.current.batchDraw();\n      }\n    });\n  };\n\n  var _onDragMove = function _onDragMove(e) {\n    var linesArray = $layer.current.find(\".guid-line\");\n\n    if (!!linesArray.length) {\n      linesArray.forEach(function (item) {\n        return item.destroy();\n      });\n    }\n\n    var lineGuideStops = getLineGuideStops(e.target);\n    var itemBounds = getObjectSnappingEdges(e.target);\n    var guides = getGuides(lineGuideStops, itemBounds);\n\n    if (!guides.length) {\n      return;\n    }\n\n    drawGuides(guides);\n    guides.forEach(function (lg) {\n      switch (lg.snap) {\n        case \"start\":\n          {\n            switch (lg.orientation) {\n              case \"V\":\n                {\n                  e.target.x(lg.lineGuide + lg.offset);\n                  break;\n                }\n\n              case \"H\":\n                {\n                  e.target.y(lg.lineGuide + lg.offset);\n                  break;\n                }\n\n              default:\n                return;\n            }\n\n            break;\n          }\n\n        case \"center\":\n          {\n            switch (lg.orientation) {\n              case \"V\":\n                {\n                  e.target.x(lg.lineGuide + lg.offset);\n                  break;\n                }\n\n              case \"H\":\n                {\n                  e.target.y(lg.lineGuide + lg.offset);\n                  break;\n                }\n\n              default:\n                return;\n            }\n\n            break;\n          }\n\n        case \"end\":\n          {\n            switch (lg.orientation) {\n              case \"V\":\n                {\n                  e.target.x(lg.lineGuide + lg.offset);\n                  break;\n                }\n\n              case \"H\":\n                {\n                  e.target.y(lg.lineGuide + lg.offset);\n                  break;\n                }\n\n              default:\n                return;\n            }\n\n            break;\n          }\n\n        default:\n          return;\n      }\n    });\n  };\n\n  var _onDragEnd = function _onDragEnd(e) {\n    var linesArray = $layer.current.find(\".guid-line\");\n\n    if (!!linesArray.length) {\n      linesArray.forEach(function (item) {\n        return item.destroy();\n      });\n    }\n\n    $layer.current.batchDraw();\n  };\n\n  var checkDeselect = function checkDeselect(e) {\n    // deselect when clicked on empty area\n    var clickedOnEmpty = e.target === e.target.getStage();\n\n    if (clickedOnEmpty) {\n      unSelectAll();\n      $tr.current.nodes([]);\n      setNodes([]); // layerRef.current.remove(selectionRectangle);\n    }\n  };\n\n  var updateSelectionRect = function updateSelectionRect() {\n    var node = selectionRectRef.current;\n    node.setAttrs({\n      visible: selection.current.visible,\n      x: Math.min(selection.current.x1, selection.current.x2),\n      y: Math.min(selection.current.y1, selection.current.y2),\n      width: Math.abs(selection.current.x1 - selection.current.x2),\n      height: Math.abs(selection.current.y1 - selection.current.y2),\n      fill: \"rgba(0, 161, 255, 0.3)\"\n    });\n    node.getLayer().batchDraw();\n  };\n\n  var oldPos = React.useRef(null);\n\n  var onMouseDown = function onMouseDown(e) {\n    var isElement = e.target.findAncestor(\".elements-container\");\n    var isTransformer = e.target.findAncestor(\"Transformer\");\n\n    if (isElement || isTransformer) {\n      return;\n    }\n\n    var pos = e.target.getStage().getPointerPosition();\n    selection.current.visible = true;\n    selection.current.x1 = pos.x;\n    selection.current.y1 = pos.y;\n    selection.current.x2 = pos.x;\n    selection.current.y2 = pos.y;\n    updateSelectionRect();\n  };\n\n  var onMouseMove = function onMouseMove(e) {\n    if (!selection.current.visible) {\n      return;\n    }\n\n    var pos = e.target.getStage().getPointerPosition();\n    selection.current.x2 = pos.x;\n    selection.current.y2 = pos.y;\n    updateSelectionRect();\n  };\n\n  var onMouseUp = function onMouseUp() {\n    oldPos.current = null;\n\n    if (!selection.current.visible) {\n      return;\n    }\n\n    var selBox = selectionRectRef.current.getClientRect();\n    var elements = [];\n    $layer.current.find(\".object\").forEach(function (elementNode) {\n      var elBox = elementNode.getClientRect();\n\n      if (Konva.Util.haveIntersection(selBox, elBox)) {\n        elements.push(elementNode);\n      }\n    });\n    $tr.current.nodes(elements);\n    selection.current.visible = false; // disable click event\n\n    Konva.listenClickTap = false;\n    updateSelectionRect();\n  };\n\n  var onClickTap = function onClickTap(e) {\n    // if we are selecting with rect, do nothing\n    if (selectionRectRef.current.visible()) {\n      return;\n    }\n\n    var stage = e.target.getStage();\n    var layer = $layer.current;\n    var tr = $tr.current; // if click on empty area - remove all selections\n\n    if (e.target === stage) {\n      unSelectAll();\n      setNodes([]);\n      tr.nodes([]);\n      layer.draw();\n      return;\n    } // do nothing if clicked NOT on our rectangles\n\n\n    if (!e.target.hasName(\".object\")) {\n      return;\n    } // do we pressed shift or ctrl?\n\n\n    var metaPressed = e.evt.shiftKey || e.evt.ctrlKey || e.evt.metaKey;\n    var isSelected = tr.nodes().indexOf(e.target) >= 0;\n\n    if (!metaPressed && !isSelected) {\n      // if no key pressed and the node is not selected\n      // select just one\n      tr.nodes([e.target]);\n    } else if (metaPressed && isSelected) {\n      // if we pressed keys and node was selected\n      // we need to remove it from selection:\n      var nodes = tr.nodes().slice(); // use slice to have new copy of array\n      // remove node from array\n\n      nodes.splice(nodes.indexOf(e.target), 1);\n      tr.nodes(nodes);\n    } else if (metaPressed && !isSelected) {\n      // add the node into selection\n      var _nodes = tr.nodes().concat([e.target]);\n\n      tr.nodes(_nodes);\n    }\n\n    layer.draw();\n  };\n\n  console.log({\n    variation: templateData.variations[variationIndex]\n  });\n  return __jsx(Stage, _extends({\n    ref: $stage,\n    onMouseDown: onMouseDown,\n    onMouseUp: onMouseUp,\n    onMouseMove: onMouseMove,\n    onTouchStart: checkDeselect,\n    onClick: onClickTap\n  }, stageDimensions, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 378,\n      columnNumber: 9\n    }\n  }), __jsx(Layer, {\n    ref: $layer,\n    onDragMove: _onDragMove,\n    onDragEnd: _onDragEnd,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 387,\n      columnNumber: 13\n    }\n  }, (_templateData$variati = templateData.variations[variationIndex].shapes) === null || _templateData$variati === void 0 ? void 0 : (_templateData$variati2 = _templateData$variati.filter(function (item) {\n    return item.type === \"rectangle\";\n  })) === null || _templateData$variati2 === void 0 ? void 0 : _templateData$variati2.map(function (rect, i) {\n    return __jsx(Rectangle, {\n      key: i,\n      shapeProps: rect,\n      onSelect: function onSelect(e) {\n        if (e.current !== undefined) {\n          var temp = nodesArray;\n          if (!nodesArray.includes(e.current)) temp.push(e.current);\n          setNodes(temp);\n          $tr.current.nodes(nodesArray);\n          $tr.current.nodes(nodesArray);\n          $tr.current.getLayer().batchDraw();\n        }\n\n        setSelectedId(rect.id);\n      } // onSelect={() => {\n      //     setSelectedId(rect.id)\n      // }}\n      ,\n      onEditClick: handleEditSelectedItem,\n      onChange: function onChange(newAttrs) {\n        setTemplateData(function (prev) {\n          var index = prev.variations[variationIndex].shapes.findIndex(function (item) {\n            return item.id === rect.id;\n          });\n          prev.variations[variationIndex].shapes[index] = newAttrs;\n        });\n      },\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 394,\n        columnNumber: 25\n      }\n    });\n  }), (_templateData$variati3 = templateData.variations[variationIndex].shapes) === null || _templateData$variati3 === void 0 ? void 0 : (_templateData$variati4 = _templateData$variati3.filter(function (item) {\n    return item.type === \"circle\";\n  })) === null || _templateData$variati4 === void 0 ? void 0 : _templateData$variati4.map(function (circle, i) {\n    return __jsx(UCircle, {\n      key: i,\n      shapeProps: circle,\n      onSelect: function onSelect() {\n        setSelectedId(circle.id);\n      },\n      onEditClick: handleEditSelectedItem,\n      onChange: function onChange(newAttrs) {\n        setTemplateData(function (prev) {\n          var index = prev.variations[variationIndex].shapes.findIndex(function (item) {\n            return item.id === circle.id;\n          });\n          prev.variations[variationIndex].shapes[index] = newAttrs;\n        });\n      },\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 423,\n        columnNumber: 25\n      }\n    });\n  }), (_templateData$variati5 = templateData.variations[variationIndex].shapes) === null || _templateData$variati5 === void 0 ? void 0 : (_templateData$variati6 = _templateData$variati5.filter(function (item) {\n    return item.type === \"line\";\n  })) === null || _templateData$variati6 === void 0 ? void 0 : _templateData$variati6.map(function (line, i) {\n    return __jsx(ULine, {\n      key: i,\n      shapeProps: line,\n      onSelect: function onSelect() {\n        setSelectedId(line.id);\n      },\n      onEditClick: handleEditSelectedItem,\n      onChange: function onChange(newAttrs) {\n        setTemplateData(function (prev) {\n          var index = prev.variations[variationIndex].shapes.findIndex(function (item) {\n            return item.id === line.id;\n          });\n          prev.variations[variationIndex].shapes[index] = newAttrs;\n        });\n      },\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 441,\n        columnNumber: 25\n      }\n    });\n  }), (_templateData$variati7 = templateData.variations[variationIndex].shapes) === null || _templateData$variati7 === void 0 ? void 0 : (_templateData$variati8 = _templateData$variati7.filter(function (item) {\n    return item.type === \"polygon\";\n  })) === null || _templateData$variati8 === void 0 ? void 0 : _templateData$variati8.map(function (polygon, i) {\n    return __jsx(UPolygon, {\n      key: i,\n      shapeProps: polygon,\n      onSelect: function onSelect() {\n        setSelectedId(polygon.id);\n      },\n      onEditClick: handleEditSelectedItem,\n      onChange: function onChange(newAttrs) {\n        setTemplateData(function (prev) {\n          var index = prev.variations[variationIndex].shapes.findIndex(function (item) {\n            return item.id === polygon.id;\n          });\n          prev.variations[variationIndex].shapes[index] = newAttrs;\n        });\n      },\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 459,\n        columnNumber: 25\n      }\n    });\n  }), (_templateData$variati9 = templateData.variations[variationIndex].svgs) === null || _templateData$variati9 === void 0 ? void 0 : _templateData$variati9.map(function (item, index) {\n    return __jsx(USvg, {\n      key: index,\n      svgProps: item,\n      onSelect: function onSelect() {\n        setSelectedId(item.id);\n      },\n      onEditClick: handleEditSelectedItem,\n      onChange: function onChange(event) {\n        return setTemplateData(function (prev) {\n          prev.variations[variationIndex].svgs[index] = _objectSpread(_objectSpread({}, prev.variations[variationIndex].svgs[index]), JSON.parse(JSON.stringify(event.target.attrs)));\n        });\n      },\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 476,\n        columnNumber: 21\n      }\n    });\n  }), (_templateData$variati10 = templateData.variations[variationIndex].images) === null || _templateData$variati10 === void 0 ? void 0 : _templateData$variati10.map(function (item, index) {\n    return __jsx(UImage, {\n      key: index,\n      imageProps: item,\n      onSelect: function onSelect() {\n        setSelectedId(item.id);\n      },\n      onChange: function onChange(event) {\n        return setTemplateData(function (prev) {\n          prev.variations[variationIndex].images[index] = _objectSpread(_objectSpread({}, prev.variations[variationIndex].images[index]), JSON.parse(JSON.stringify(event.target.attrs)));\n        });\n      },\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 492,\n        columnNumber: 21\n      }\n    });\n  }), (_templateData$variati11 = templateData.variations[variationIndex].textBoxes) === null || _templateData$variati11 === void 0 ? void 0 : _templateData$variati11.map(function (item, index) {\n    return __jsx(UText, {\n      key: index,\n      textProps: item,\n      onSelect: function onSelect() {\n        setSelectedId(item.id);\n      },\n      onEditClick: handleEditSelectedItem,\n      onChange: function onChange(event) {\n        return setTemplateData(function (prev) {\n          prev.variations[variationIndex].textBoxes[index] = _objectSpread({}, event.target.attrs);\n        });\n      },\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 507,\n        columnNumber: 21\n      }\n    });\n  }), __jsx(TransformerComponent, {\n    id: \"tr\".concat(selectedId),\n    $tr: $tr,\n    selectedShapeName: selectedId,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 519,\n      columnNumber: 17\n    }\n  }), __jsx(Rect, {\n    fill: \"rgba(0,0,255,0.5)\",\n    ref: selectionRectRef,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 524,\n      columnNumber: 17\n    }\n  })));\n};\n\nexport default MainStage;","map":{"version":3,"sources":["D:/dev/cardclan-backend/template-tool/src/components/DesignTool/MainStage/index.tsx"],"names":["React","useRef","useState","Stage","Layer","Rect","Rectangle","UCircle","UPolygon","ULine","USvg","UText","TransformerComponent","stageDimensions","UImage","MainStage","templateData","setTemplateData","variationIndex","selectedId","setSelectedId","unSelectAll","handleEditSelectedItem","GUIDELINE_OFFSET","$stage","$layer","$tr","selectionRectRef","selection","visible","x1","y1","x2","y2","nodesArray","setNodes","Konva","window","getLineGuideStops","skipShape","vertical","width","horizontal","height","current","find","forEach","guideItem","box","getClientRect","push","x","y","flat","getObjectSnappingEdges","node","guide","Math","round","offset","snap","getGuides","lineGuideStops","itemBounds","resultV","resultH","lineGuide","itemBound","diff","abs","guides","minV","sort","a","b","minH","orientation","drawGuides","lg","lines","Line","points","stroke","strokeWidth","name","dash","add","batchDraw","_onDragMove","e","linesArray","length","item","destroy","target","_onDragEnd","checkDeselect","clickedOnEmpty","getStage","nodes","updateSelectionRect","setAttrs","min","fill","getLayer","oldPos","onMouseDown","isElement","findAncestor","isTransformer","pos","getPointerPosition","onMouseMove","onMouseUp","selBox","elements","elementNode","elBox","Util","haveIntersection","listenClickTap","onClickTap","stage","layer","tr","draw","hasName","metaPressed","evt","shiftKey","ctrlKey","metaKey","isSelected","indexOf","slice","splice","concat","console","log","variation","variations","shapes","filter","type","map","rect","i","undefined","temp","includes","id","newAttrs","prev","index","findIndex","circle","line","polygon","svgs","event","JSON","parse","stringify","attrs","images","textBoxes"],"mappings":";;;;;;;AAAA,OAAOA,KAAP,IAAgBC,MAAhB,EAAwBC,QAAxB,QAAwC,OAAxC;AACA,SAASC,KAAT,EAAgBC,KAAhB,EAAuBC,IAAvB,QAAmC,aAAnC;AACA,OAAOC,SAAP,MAAsB,cAAtB;AACA,OAAOC,OAAP,MAAoB,YAApB;AACA,OAAOC,QAAP,MAAqB,aAArB;AACA,OAAOC,KAAP,MAAkB,UAAlB;AACA,OAAOC,IAAP,MAAiB,SAAjB;AACA,OAAOC,KAAP,MAAkB,UAAlB;AACA,OAAOC,oBAAP,MAAiC,iBAAjC;AACA,SAASC,eAAT,QAAgC,yBAAhC;AACA,OAAOC,MAAP,MAAmB,WAAnB;;AAIA,IAAMC,SAAS,GAAG,SAAZA,SAAY,OAQZ;AAAA;;AAAA,MAPFC,YAOE,QAPFA,YAOE;AAAA,MANFC,eAME,QANFA,eAME;AAAA,MALFC,cAKE,QALFA,cAKE;AAAA,MAJFC,UAIE,QAJFA,UAIE;AAAA,MAHFC,aAGE,QAHFA,aAGE;AAAA,MAFFC,WAEE,QAFFA,WAEE;AAAA,MADFC,sBACE,QADFA,sBACE;AAEF,MAAMC,gBAAgB,GAAG,CAAzB;AACA,MAAMC,MAAM,GAAGvB,MAAM,CAAC,IAAD,CAArB;AACA,MAAMwB,MAAM,GAAGxB,MAAM,CAAC,IAAD,CAArB;AACA,MAAMyB,GAAG,GAAGzB,MAAM,CAAC,IAAD,CAAlB;AACA,MAAM0B,gBAAgB,GAAG1B,MAAM,CAAC,IAAD,CAA/B;AACA,MAAM2B,SAAS,GAAG3B,MAAM,CAAC;AACrB4B,IAAAA,OAAO,EAAE,KADY;AAErBC,IAAAA,EAAE,EAAE,CAFiB;AAGrBC,IAAAA,EAAE,EAAE,CAHiB;AAIrBC,IAAAA,EAAE,EAAE,CAJiB;AAKrBC,IAAAA,EAAE,EAAE;AALiB,GAAD,CAAxB;;AAQA,kBAA+B/B,QAAQ,CAAC,EAAD,CAAvC;AAAA,MAAOgC,UAAP;AAAA,MAAmBC,QAAnB;;AACA,MAAMC,KAAK,GAAGC,MAAM,CAACD,KAArB;;AAEA,MAAME,iBAAiB,GAAG,SAApBA,iBAAoB,CAAAC,SAAS,EAAI;AACnC,QAAMC,QAAa,GAAG,CAAC,CAAD,EAAI3B,eAAe,CAAC4B,KAAhB,GAAwB,CAA5B,EAA+B5B,eAAe,CAAC4B,KAA/C,CAAtB;AACA,QAAMC,UAAe,GAAG,CAAC,CAAD,EAAI7B,eAAe,CAAC8B,MAAhB,GAAyB,CAA7B,EAAgC9B,eAAe,CAAC8B,MAAhD,CAAxB,CAFmC,CAInC;;AACAnB,IAAAA,MAAM,CAACoB,OAAP,CAAeC,IAAf,CAAoB,SAApB,EAA+BC,OAA/B,CAAuC,UAAAC,SAAS,EAAI;AAChD,UAAIA,SAAS,KAAKR,SAAlB,EAA6B;AACzB;AACH;;AACD,UAAMS,GAAG,GAAGD,SAAS,CAACE,aAAV,EAAZ,CAJgD,CAKhD;;AACAT,MAAAA,QAAQ,CAACU,IAAT,CAAc,CAACF,GAAG,CAACG,CAAL,EAAQH,GAAG,CAACG,CAAJ,GAAQH,GAAG,CAACP,KAApB,EAA2BO,GAAG,CAACG,CAAJ,GAAQH,GAAG,CAACP,KAAJ,GAAY,CAA/C,CAAd;AACAC,MAAAA,UAAU,CAACQ,IAAX,CAAgB,CAACF,GAAG,CAACI,CAAL,EAAQJ,GAAG,CAACI,CAAJ,GAAQJ,GAAG,CAACL,MAApB,EAA4BK,GAAG,CAACI,CAAJ,GAAQJ,GAAG,CAACL,MAAJ,GAAa,CAAjD,CAAhB;AACH,KARD;AASA,WAAO;AACHH,MAAAA,QAAQ,EAAEA,QAAQ,CAACa,IAAT,EADP;AAEHX,MAAAA,UAAU,EAAEA,UAAU,CAACW,IAAX;AAFT,KAAP;AAIH,GAlBD;;AAoBA,MAAMC,sBAAsB,GAAG,SAAzBA,sBAAyB,CAAAC,IAAI,EAAI;AACnC,QAAMP,GAAG,GAAGO,IAAI,CAACN,aAAL,EAAZ;AAEA,WAAO;AACHT,MAAAA,QAAQ,EAAE,CACN;AACIgB,QAAAA,KAAK,EAAEC,IAAI,CAACC,KAAL,CAAWV,GAAG,CAACG,CAAf,CADX;AAEIQ,QAAAA,MAAM,EAAEF,IAAI,CAACC,KAAL,CAAWH,IAAI,CAACJ,CAAL,KAAWH,GAAG,CAACG,CAA1B,CAFZ;AAGIS,QAAAA,IAAI,EAAE;AAHV,OADM,EAMN;AACIJ,QAAAA,KAAK,EAAEC,IAAI,CAACC,KAAL,CAAWV,GAAG,CAACG,CAAJ,GAAQH,GAAG,CAACP,KAAJ,GAAY,CAA/B,CADX;AAEIkB,QAAAA,MAAM,EAAEF,IAAI,CAACC,KAAL,CAAWH,IAAI,CAACJ,CAAL,KAAWH,GAAG,CAACG,CAAf,GAAmBH,GAAG,CAACP,KAAJ,GAAY,CAA1C,CAFZ;AAGImB,QAAAA,IAAI,EAAE;AAHV,OANM,EAWN;AACIJ,QAAAA,KAAK,EAAEC,IAAI,CAACC,KAAL,CAAWV,GAAG,CAACG,CAAJ,GAAQH,GAAG,CAACP,KAAvB,CADX;AAEIkB,QAAAA,MAAM,EAAEF,IAAI,CAACC,KAAL,CAAWH,IAAI,CAACJ,CAAL,KAAWH,GAAG,CAACG,CAAf,GAAmBH,GAAG,CAACP,KAAlC,CAFZ;AAGImB,QAAAA,IAAI,EAAE;AAHV,OAXM,CADP;AAkBHlB,MAAAA,UAAU,EAAE,CACR;AACIc,QAAAA,KAAK,EAAEC,IAAI,CAACC,KAAL,CAAWV,GAAG,CAACI,CAAf,CADX;AAEIO,QAAAA,MAAM,EAAEF,IAAI,CAACC,KAAL,CAAWH,IAAI,CAACH,CAAL,KAAWJ,GAAG,CAACI,CAA1B,CAFZ;AAGIQ,QAAAA,IAAI,EAAE;AAHV,OADQ,EAMR;AACIJ,QAAAA,KAAK,EAAEC,IAAI,CAACC,KAAL,CAAWV,GAAG,CAACI,CAAJ,GAAQJ,GAAG,CAACL,MAAJ,GAAa,CAAhC,CADX;AAEIgB,QAAAA,MAAM,EAAEF,IAAI,CAACC,KAAL,CAAWH,IAAI,CAACH,CAAL,KAAWJ,GAAG,CAACI,CAAf,GAAmBJ,GAAG,CAACL,MAAJ,GAAa,CAA3C,CAFZ;AAGIiB,QAAAA,IAAI,EAAE;AAHV,OANQ,EAWR;AACIJ,QAAAA,KAAK,EAAEC,IAAI,CAACC,KAAL,CAAWV,GAAG,CAACI,CAAJ,GAAQJ,GAAG,CAACL,MAAvB,CADX;AAEIgB,QAAAA,MAAM,EAAEF,IAAI,CAACC,KAAL,CAAWH,IAAI,CAACH,CAAL,KAAWJ,GAAG,CAACI,CAAf,GAAmBJ,GAAG,CAACL,MAAlC,CAFZ;AAGIiB,QAAAA,IAAI,EAAE;AAHV,OAXQ;AAlBT,KAAP;AAoCH,GAvCD;;AAyCA,MAAMC,SAAS,GAAG,SAAZA,SAAY,CAACC,cAAD,EAAiBC,UAAjB,EAAgC;AAC9C,QAAMC,OAAO,GAAG,EAAhB;AACA,QAAMC,OAAO,GAAG,EAAhB;AAEAH,IAAAA,cAAc,CAACtB,QAAf,CAAwBM,OAAxB,CAAgC,UAAAoB,SAAS,EAAI;AACzCH,MAAAA,UAAU,CAACvB,QAAX,CAAoBM,OAApB,CAA4B,UAAAqB,SAAS,EAAI;AACrC,YAAMC,IAAI,GAAGX,IAAI,CAACY,GAAL,CAASH,SAAS,GAAGC,SAAS,CAACX,KAA/B,CAAb,CADqC,CAErC;;AACA,YAAIY,IAAI,GAAG7C,gBAAX,EAA6B;AACzByC,UAAAA,OAAO,CAACd,IAAR,CAAa;AACTgB,YAAAA,SAAS,EAAEA,SADF;AAETE,YAAAA,IAAI,EAAEA,IAFG;AAGTR,YAAAA,IAAI,EAAEO,SAAS,CAACP,IAHP;AAITD,YAAAA,MAAM,EAAEQ,SAAS,CAACR;AAJT,WAAb;AAMH;AACJ,OAXD;AAYH,KAbD;AAeAG,IAAAA,cAAc,CAACpB,UAAf,CAA0BI,OAA1B,CAAkC,UAAAoB,SAAS,EAAI;AAC3CH,MAAAA,UAAU,CAACrB,UAAX,CAAsBI,OAAtB,CAA8B,UAAAqB,SAAS,EAAI;AACvC,YAAMC,IAAI,GAAGX,IAAI,CAACY,GAAL,CAASH,SAAS,GAAGC,SAAS,CAACX,KAA/B,CAAb;;AACA,YAAIY,IAAI,GAAG7C,gBAAX,EAA6B;AACzB0C,UAAAA,OAAO,CAACf,IAAR,CAAa;AACTgB,YAAAA,SAAS,EAAEA,SADF;AAETE,YAAAA,IAAI,EAAEA,IAFG;AAGTR,YAAAA,IAAI,EAAEO,SAAS,CAACP,IAHP;AAITD,YAAAA,MAAM,EAAEQ,SAAS,CAACR;AAJT,WAAb;AAMH;AACJ,OAVD;AAWH,KAZD;AAcA,QAAMW,MAAM,GAAG,EAAf,CAjC8C,CAmC9C;;AACA,QAAMC,IAAI,GAAGP,OAAO,CAACQ,IAAR,CAAa,UAACC,CAAD,EAAIC,CAAJ;AAAA,aAAUD,CAAC,CAACL,IAAF,GAASM,CAAC,CAACN,IAArB;AAAA,KAAb,EAAwC,CAAxC,CAAb;AACA,QAAMO,IAAI,GAAGV,OAAO,CAACO,IAAR,CAAa,UAACC,CAAD,EAAIC,CAAJ;AAAA,aAAUD,CAAC,CAACL,IAAF,GAASM,CAAC,CAACN,IAArB;AAAA,KAAb,EAAwC,CAAxC,CAAb;;AACA,QAAIG,IAAJ,EAAU;AACND,MAAAA,MAAM,CAACpB,IAAP,CAAY;AACRgB,QAAAA,SAAS,EAAEK,IAAI,CAACL,SADR;AAERP,QAAAA,MAAM,EAAEY,IAAI,CAACZ,MAFL;AAGRiB,QAAAA,WAAW,EAAE,GAHL;AAIRhB,QAAAA,IAAI,EAAEW,IAAI,CAACX;AAJH,OAAZ;AAMH;;AACD,QAAIe,IAAJ,EAAU;AACNL,MAAAA,MAAM,CAACpB,IAAP,CAAY;AACRgB,QAAAA,SAAS,EAAES,IAAI,CAACT,SADR;AAERP,QAAAA,MAAM,EAAEgB,IAAI,CAAChB,MAFL;AAGRiB,QAAAA,WAAW,EAAE,GAHL;AAIRhB,QAAAA,IAAI,EAAEe,IAAI,CAACf;AAJH,OAAZ;AAMH;;AACD,WAAOU,MAAP;AACH,GAvDD;;AAyDA,MAAMO,UAAU,GAAG,SAAbA,UAAa,CAAAP,MAAM,EAAI;AACzBA,IAAAA,MAAM,CAACxB,OAAP,CAAe,UAAAgC,EAAE,EAAI;AACjB,UAAIA,EAAE,CAACF,WAAH,KAAmB,GAAvB,EAA4B;AACxB,YAAMG,KAAK,GAAG,IAAI3C,KAAK,CAAC4C,IAAV,CAAe;AACzBC,UAAAA,MAAM,EAAE,CAAC,CAAC,IAAF,EAAQH,EAAE,CAACZ,SAAX,EAAsB,IAAtB,EAA4BY,EAAE,CAACZ,SAA/B,CADiB;AAEzBgB,UAAAA,MAAM,EAAE,kBAFiB;AAGzBC,UAAAA,WAAW,EAAE,CAHY;AAIzBC,UAAAA,IAAI,EAAE,WAJmB;AAKzBC,UAAAA,IAAI,EAAE,CAAC,CAAD,EAAI,CAAJ;AALmB,SAAf,CAAd;AAOA5D,QAAAA,MAAM,CAACmB,OAAP,CAAe0C,GAAf,CAAmBP,KAAnB;AACAtD,QAAAA,MAAM,CAACmB,OAAP,CAAe2C,SAAf;AACH,OAVD,MAUO,IAAIT,EAAE,CAACF,WAAH,KAAmB,GAAvB,EAA4B;AAC/B,YAAMG,MAAK,GAAG,IAAI3C,KAAK,CAAC4C,IAAV,CAAe;AACzBC,UAAAA,MAAM,EAAE,CAACH,EAAE,CAACZ,SAAJ,EAAe,CAAC,IAAhB,EAAsBY,EAAE,CAACZ,SAAzB,EAAoC,IAApC,CADiB;AAEzBgB,UAAAA,MAAM,EAAE,kBAFiB;AAGzBC,UAAAA,WAAW,EAAE,CAHY;AAIzBC,UAAAA,IAAI,EAAE,WAJmB;AAKzBC,UAAAA,IAAI,EAAE,CAAC,CAAD,EAAI,CAAJ;AALmB,SAAf,CAAd;;AAOA5D,QAAAA,MAAM,CAACmB,OAAP,CAAe0C,GAAf,CAAmBP,MAAnB;AACAtD,QAAAA,MAAM,CAACmB,OAAP,CAAe2C,SAAf;AACH;AACJ,KAtBD;AAuBH,GAxBD;;AA0BA,MAAMC,WAAW,GAAG,SAAdA,WAAc,CAAAC,CAAC,EAAI;AACrB,QAAMC,UAAU,GAAGjE,MAAM,CAACmB,OAAP,CAAeC,IAAf,CAAoB,YAApB,CAAnB;;AACA,QAAI,CAAC,CAAC6C,UAAU,CAACC,MAAjB,EAAyB;AACrBD,MAAAA,UAAU,CAAC5C,OAAX,CAAmB,UAAA8C,IAAI;AAAA,eAAIA,IAAI,CAACC,OAAL,EAAJ;AAAA,OAAvB;AACH;;AACD,QAAM/B,cAAc,GAAGxB,iBAAiB,CAACmD,CAAC,CAACK,MAAH,CAAxC;AACA,QAAM/B,UAAU,GAAGT,sBAAsB,CAACmC,CAAC,CAACK,MAAH,CAAzC;AACA,QAAMxB,MAAM,GAAGT,SAAS,CAACC,cAAD,EAAiBC,UAAjB,CAAxB;;AACA,QAAI,CAACO,MAAM,CAACqB,MAAZ,EAAoB;AAChB;AACH;;AACDd,IAAAA,UAAU,CAACP,MAAD,CAAV;AACAA,IAAAA,MAAM,CAACxB,OAAP,CAAe,UAAAgC,EAAE,EAAI;AACjB,cAAQA,EAAE,CAAClB,IAAX;AACI,aAAK,OAAL;AAAc;AACV,oBAAQkB,EAAE,CAACF,WAAX;AACI,mBAAK,GAAL;AAAU;AACNa,kBAAAA,CAAC,CAACK,MAAF,CAAS3C,CAAT,CAAW2B,EAAE,CAACZ,SAAH,GAAeY,EAAE,CAACnB,MAA7B;AACA;AACH;;AACD,mBAAK,GAAL;AAAU;AACN8B,kBAAAA,CAAC,CAACK,MAAF,CAAS1C,CAAT,CAAW0B,EAAE,CAACZ,SAAH,GAAeY,EAAE,CAACnB,MAA7B;AACA;AACH;;AACD;AACI;AAVR;;AAYA;AACH;;AACD,aAAK,QAAL;AAAe;AACX,oBAAQmB,EAAE,CAACF,WAAX;AACI,mBAAK,GAAL;AAAU;AACNa,kBAAAA,CAAC,CAACK,MAAF,CAAS3C,CAAT,CAAW2B,EAAE,CAACZ,SAAH,GAAeY,EAAE,CAACnB,MAA7B;AACA;AACH;;AACD,mBAAK,GAAL;AAAU;AACN8B,kBAAAA,CAAC,CAACK,MAAF,CAAS1C,CAAT,CAAW0B,EAAE,CAACZ,SAAH,GAAeY,EAAE,CAACnB,MAA7B;AACA;AACH;;AACD;AACI;AAVR;;AAYA;AACH;;AACD,aAAK,KAAL;AAAY;AACR,oBAAQmB,EAAE,CAACF,WAAX;AACI,mBAAK,GAAL;AAAU;AACNa,kBAAAA,CAAC,CAACK,MAAF,CAAS3C,CAAT,CAAW2B,EAAE,CAACZ,SAAH,GAAeY,EAAE,CAACnB,MAA7B;AACA;AACH;;AACD,mBAAK,GAAL;AAAU;AACN8B,kBAAAA,CAAC,CAACK,MAAF,CAAS1C,CAAT,CAAW0B,EAAE,CAACZ,SAAH,GAAeY,EAAE,CAACnB,MAA7B;AACA;AACH;;AACD;AACI;AAVR;;AAYA;AACH;;AACD;AACI;AA/CR;AAiDH,KAlDD;AAmDH,GA/DD;;AAiEA,MAAMoC,UAAU,GAAG,SAAbA,UAAa,CAAAN,CAAC,EAAI;AACpB,QAAMC,UAAU,GAAGjE,MAAM,CAACmB,OAAP,CAAeC,IAAf,CAAoB,YAApB,CAAnB;;AACA,QAAI,CAAC,CAAC6C,UAAU,CAACC,MAAjB,EAAyB;AACrBD,MAAAA,UAAU,CAAC5C,OAAX,CAAmB,UAAA8C,IAAI;AAAA,eAAIA,IAAI,CAACC,OAAL,EAAJ;AAAA,OAAvB;AACH;;AACDpE,IAAAA,MAAM,CAACmB,OAAP,CAAe2C,SAAf;AACH,GAND;;AAQA,MAAMS,aAAa,GAAG,SAAhBA,aAAgB,CAACP,CAAD,EAAO;AACzB;AACA,QAAMQ,cAAc,GAAGR,CAAC,CAACK,MAAF,KAAaL,CAAC,CAACK,MAAF,CAASI,QAAT,EAApC;;AACA,QAAID,cAAJ,EAAoB;AAChB5E,MAAAA,WAAW;AACXK,MAAAA,GAAG,CAACkB,OAAJ,CAAYuD,KAAZ,CAAkB,EAAlB;AACAhE,MAAAA,QAAQ,CAAC,EAAD,CAAR,CAHgB,CAIhB;AACH;AACJ,GATD;;AAWA,MAAMiE,mBAAmB,GAAG,SAAtBA,mBAAsB,GAAM;AAC9B,QAAM7C,IAAI,GAAG5B,gBAAgB,CAACiB,OAA9B;AACAW,IAAAA,IAAI,CAAC8C,QAAL,CAAc;AACVxE,MAAAA,OAAO,EAAED,SAAS,CAACgB,OAAV,CAAkBf,OADjB;AAEVsB,MAAAA,CAAC,EAAEM,IAAI,CAAC6C,GAAL,CAAS1E,SAAS,CAACgB,OAAV,CAAkBd,EAA3B,EAA+BF,SAAS,CAACgB,OAAV,CAAkBZ,EAAjD,CAFO;AAGVoB,MAAAA,CAAC,EAAEK,IAAI,CAAC6C,GAAL,CAAS1E,SAAS,CAACgB,OAAV,CAAkBb,EAA3B,EAA+BH,SAAS,CAACgB,OAAV,CAAkBX,EAAjD,CAHO;AAIVQ,MAAAA,KAAK,EAAEgB,IAAI,CAACY,GAAL,CAASzC,SAAS,CAACgB,OAAV,CAAkBd,EAAlB,GAAuBF,SAAS,CAACgB,OAAV,CAAkBZ,EAAlD,CAJG;AAKVW,MAAAA,MAAM,EAAEc,IAAI,CAACY,GAAL,CAASzC,SAAS,CAACgB,OAAV,CAAkBb,EAAlB,GAAuBH,SAAS,CAACgB,OAAV,CAAkBX,EAAlD,CALE;AAMVsE,MAAAA,IAAI,EAAE;AANI,KAAd;AAQAhD,IAAAA,IAAI,CAACiD,QAAL,GAAgBjB,SAAhB;AACH,GAXD;;AAaA,MAAMkB,MAAM,GAAGzG,KAAK,CAACC,MAAN,CAAa,IAAb,CAAf;;AACA,MAAMyG,WAAW,GAAG,SAAdA,WAAc,CAACjB,CAAD,EAAO;AACvB,QAAMkB,SAAS,GAAGlB,CAAC,CAACK,MAAF,CAASc,YAAT,CAAsB,qBAAtB,CAAlB;AACA,QAAMC,aAAa,GAAGpB,CAAC,CAACK,MAAF,CAASc,YAAT,CAAsB,aAAtB,CAAtB;;AACA,QAAID,SAAS,IAAIE,aAAjB,EAAgC;AAC5B;AACH;;AAED,QAAMC,GAAG,GAAGrB,CAAC,CAACK,MAAF,CAASI,QAAT,GAAoBa,kBAApB,EAAZ;AACAnF,IAAAA,SAAS,CAACgB,OAAV,CAAkBf,OAAlB,GAA4B,IAA5B;AACAD,IAAAA,SAAS,CAACgB,OAAV,CAAkBd,EAAlB,GAAuBgF,GAAG,CAAC3D,CAA3B;AACAvB,IAAAA,SAAS,CAACgB,OAAV,CAAkBb,EAAlB,GAAuB+E,GAAG,CAAC1D,CAA3B;AACAxB,IAAAA,SAAS,CAACgB,OAAV,CAAkBZ,EAAlB,GAAuB8E,GAAG,CAAC3D,CAA3B;AACAvB,IAAAA,SAAS,CAACgB,OAAV,CAAkBX,EAAlB,GAAuB6E,GAAG,CAAC1D,CAA3B;AACAgD,IAAAA,mBAAmB;AACtB,GAdD;;AAgBA,MAAMY,WAAW,GAAG,SAAdA,WAAc,CAACvB,CAAD,EAAO;AACvB,QAAI,CAAC7D,SAAS,CAACgB,OAAV,CAAkBf,OAAvB,EAAgC;AAC5B;AACH;;AACD,QAAMiF,GAAG,GAAGrB,CAAC,CAACK,MAAF,CAASI,QAAT,GAAoBa,kBAApB,EAAZ;AACAnF,IAAAA,SAAS,CAACgB,OAAV,CAAkBZ,EAAlB,GAAuB8E,GAAG,CAAC3D,CAA3B;AACAvB,IAAAA,SAAS,CAACgB,OAAV,CAAkBX,EAAlB,GAAuB6E,GAAG,CAAC1D,CAA3B;AACAgD,IAAAA,mBAAmB;AACtB,GARD;;AAUA,MAAMa,SAAS,GAAG,SAAZA,SAAY,GAAM;AACpBR,IAAAA,MAAM,CAAC7D,OAAP,GAAiB,IAAjB;;AACA,QAAI,CAAChB,SAAS,CAACgB,OAAV,CAAkBf,OAAvB,EAAgC;AAC5B;AACH;;AACD,QAAMqF,MAAM,GAAGvF,gBAAgB,CAACiB,OAAjB,CAAyBK,aAAzB,EAAf;AAEA,QAAMkE,QAAQ,GAAG,EAAjB;AACA1F,IAAAA,MAAM,CAACmB,OAAP,CAAeC,IAAf,CAAoB,SAApB,EAA+BC,OAA/B,CAAuC,UAACsE,WAAD,EAAiB;AACpD,UAAMC,KAAK,GAAGD,WAAW,CAACnE,aAAZ,EAAd;;AACA,UAAIb,KAAK,CAACkF,IAAN,CAAWC,gBAAX,CAA4BL,MAA5B,EAAoCG,KAApC,CAAJ,EAAgD;AAC5CF,QAAAA,QAAQ,CAACjE,IAAT,CAAckE,WAAd;AACH;AACJ,KALD;AAMA1F,IAAAA,GAAG,CAACkB,OAAJ,CAAYuD,KAAZ,CAAkBgB,QAAlB;AACAvF,IAAAA,SAAS,CAACgB,OAAV,CAAkBf,OAAlB,GAA4B,KAA5B,CAfoB,CAgBpB;;AACAO,IAAAA,KAAK,CAACoF,cAAN,GAAuB,KAAvB;AACApB,IAAAA,mBAAmB;AACtB,GAnBD;;AAqBA,MAAMqB,UAAU,GAAG,SAAbA,UAAa,CAAChC,CAAD,EAAO;AACtB;AACA,QAAI9D,gBAAgB,CAACiB,OAAjB,CAAyBf,OAAzB,EAAJ,EAAwC;AACpC;AACH;;AACD,QAAI6F,KAAK,GAAGjC,CAAC,CAACK,MAAF,CAASI,QAAT,EAAZ;AACA,QAAIyB,KAAK,GAAGlG,MAAM,CAACmB,OAAnB;AACA,QAAIgF,EAAE,GAAGlG,GAAG,CAACkB,OAAb,CAPsB,CAQtB;;AACA,QAAI6C,CAAC,CAACK,MAAF,KAAa4B,KAAjB,EAAwB;AACpBrG,MAAAA,WAAW;AACXc,MAAAA,QAAQ,CAAC,EAAD,CAAR;AACAyF,MAAAA,EAAE,CAACzB,KAAH,CAAS,EAAT;AACAwB,MAAAA,KAAK,CAACE,IAAN;AACA;AACH,KAfqB,CAiBtB;;;AACA,QAAI,CAACpC,CAAC,CAACK,MAAF,CAASgC,OAAT,CAAiB,SAAjB,CAAL,EAAkC;AAC9B;AACH,KApBqB,CAsBtB;;;AACA,QAAMC,WAAW,GAAGtC,CAAC,CAACuC,GAAF,CAAMC,QAAN,IAAkBxC,CAAC,CAACuC,GAAF,CAAME,OAAxB,IAAmCzC,CAAC,CAACuC,GAAF,CAAMG,OAA7D;AACA,QAAMC,UAAU,GAAGR,EAAE,CAACzB,KAAH,GAAWkC,OAAX,CAAmB5C,CAAC,CAACK,MAArB,KAAgC,CAAnD;;AAEA,QAAI,CAACiC,WAAD,IAAgB,CAACK,UAArB,EAAiC;AAC7B;AACA;AACAR,MAAAA,EAAE,CAACzB,KAAH,CAAS,CAACV,CAAC,CAACK,MAAH,CAAT;AACH,KAJD,MAIO,IAAIiC,WAAW,IAAIK,UAAnB,EAA+B;AAClC;AACA;AACA,UAAMjC,KAAK,GAAGyB,EAAE,CAACzB,KAAH,GAAWmC,KAAX,EAAd,CAHkC,CAGA;AAClC;;AACAnC,MAAAA,KAAK,CAACoC,MAAN,CAAapC,KAAK,CAACkC,OAAN,CAAc5C,CAAC,CAACK,MAAhB,CAAb,EAAsC,CAAtC;AACA8B,MAAAA,EAAE,CAACzB,KAAH,CAASA,KAAT;AACH,KAPM,MAOA,IAAI4B,WAAW,IAAI,CAACK,UAApB,EAAgC;AACnC;AACA,UAAMjC,MAAK,GAAGyB,EAAE,CAACzB,KAAH,GAAWqC,MAAX,CAAkB,CAAC/C,CAAC,CAACK,MAAH,CAAlB,CAAd;;AACA8B,MAAAA,EAAE,CAACzB,KAAH,CAASA,MAAT;AACH;;AACDwB,IAAAA,KAAK,CAACE,IAAN;AACH,GA3CD;;AA6CAY,EAAAA,OAAO,CAACC,GAAR,CAAY;AAAEC,IAAAA,SAAS,EAAE3H,YAAY,CAAC4H,UAAb,CAAwB1H,cAAxB;AAAb,GAAZ;AAEA,SACI,MAAC,KAAD;AACI,IAAA,GAAG,EAAEM,MADT;AAEI,IAAA,WAAW,EAAEkF,WAFjB;AAGI,IAAA,SAAS,EAAEO,SAHf;AAII,IAAA,WAAW,EAAED,WAJjB;AAKI,IAAA,YAAY,EAAEhB,aALlB;AAMI,IAAA,OAAO,EAAEyB;AANb,KAOQ5G,eAPR;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MASI,MAAC,KAAD;AACI,IAAA,GAAG,EAAEY,MADT;AAEI,IAAA,UAAU,EAAE+D,WAFhB;AAGI,IAAA,SAAS,EAAEO,UAHf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAKK/E,YAAY,CAAC4H,UAAb,CAAwB1H,cAAxB,EAAwC2H,MAL7C,oFAKK,sBAAgDC,MAAhD,CAAuD,UAAAlD,IAAI;AAAA,WAAIA,IAAI,CAACmD,IAAL,KAAc,WAAlB;AAAA,GAA3D,CALL,2DAKK,uBAA2FC,GAA3F,CAA+F,UAACC,IAAD,EAAOC,CAAP,EAAa;AACzG,WACI,MAAC,SAAD;AACI,MAAA,GAAG,EAAEA,CADT;AAEI,MAAA,UAAU,EAAED,IAFhB;AAGI,MAAA,QAAQ,EAAE,kBAACxD,CAAD,EAAO;AACb,YAAIA,CAAC,CAAC7C,OAAF,KAAcuG,SAAlB,EAA6B;AACzB,cAAIC,IAAI,GAAGlH,UAAX;AACA,cAAI,CAACA,UAAU,CAACmH,QAAX,CAAoB5D,CAAC,CAAC7C,OAAtB,CAAL,EAAqCwG,IAAI,CAAClG,IAAL,CAAUuC,CAAC,CAAC7C,OAAZ;AACrCT,UAAAA,QAAQ,CAACiH,IAAD,CAAR;AACA1H,UAAAA,GAAG,CAACkB,OAAJ,CAAYuD,KAAZ,CAAkBjE,UAAlB;AACAR,UAAAA,GAAG,CAACkB,OAAJ,CAAYuD,KAAZ,CAAkBjE,UAAlB;AACAR,UAAAA,GAAG,CAACkB,OAAJ,CAAY4D,QAAZ,GAAuBjB,SAAvB;AACH;;AACDnE,QAAAA,aAAa,CAAC6H,IAAI,CAACK,EAAN,CAAb;AACH,OAbL,CAcI;AACA;AACA;AAhBJ;AAiBI,MAAA,WAAW,EAAEhI,sBAjBjB;AAkBI,MAAA,QAAQ,EAAE,kBAACiI,QAAD,EAAc;AACpBtI,QAAAA,eAAe,CAAC,UAACuI,IAAD,EAAU;AACtB,cAAMC,KAAK,GAAGD,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC2H,MAAhC,CAAuCa,SAAvC,CAAiD,UAAA9D,IAAI;AAAA,mBAAIA,IAAI,CAAC0D,EAAL,KAAYL,IAAI,CAACK,EAArB;AAAA,WAArD,CAAd;AACAE,UAAAA,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC2H,MAAhC,CAAuCY,KAAvC,IAAgDF,QAAhD;AACH,SAHc,CAAf;AAIH,OAvBL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADJ;AA2BH,GA5BA,CALL,4BAkCKvI,YAAY,CAAC4H,UAAb,CAAwB1H,cAAxB,EAAwC2H,MAlC7C,qFAkCK,uBAAgDC,MAAhD,CAAuD,UAAAlD,IAAI;AAAA,WAAIA,IAAI,CAACmD,IAAL,KAAc,QAAlB;AAAA,GAA3D,CAlCL,2DAkCK,uBAAwFC,GAAxF,CAA4F,UAACW,MAAD,EAAST,CAAT,EAAe;AACxG,WACI,MAAC,OAAD;AACI,MAAA,GAAG,EAAEA,CADT;AAEI,MAAA,UAAU,EAAES,MAFhB;AAGI,MAAA,QAAQ,EAAE,oBAAM;AACZvI,QAAAA,aAAa,CAACuI,MAAM,CAACL,EAAR,CAAb;AACH,OALL;AAMI,MAAA,WAAW,EAAEhI,sBANjB;AAOI,MAAA,QAAQ,EAAE,kBAACiI,QAAD,EAAc;AACpBtI,QAAAA,eAAe,CAAC,UAACuI,IAAD,EAAU;AACtB,cAAMC,KAAK,GAAGD,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC2H,MAAhC,CAAuCa,SAAvC,CAAiD,UAAA9D,IAAI;AAAA,mBAAIA,IAAI,CAAC0D,EAAL,KAAYK,MAAM,CAACL,EAAvB;AAAA,WAArD,CAAd;AACAE,UAAAA,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC2H,MAAhC,CAAuCY,KAAvC,IAAgDF,QAAhD;AACH,SAHc,CAAf;AAIH,OAZL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADJ;AAgBH,GAjBA,CAlCL,4BAoDKvI,YAAY,CAAC4H,UAAb,CAAwB1H,cAAxB,EAAwC2H,MApD7C,qFAoDK,uBAAgDC,MAAhD,CAAuD,UAAAlD,IAAI;AAAA,WAAIA,IAAI,CAACmD,IAAL,KAAc,MAAlB;AAAA,GAA3D,CApDL,2DAoDK,uBAAsFC,GAAtF,CAA0F,UAACY,IAAD,EAAOV,CAAP,EAAa;AACpG,WACI,MAAC,KAAD;AACI,MAAA,GAAG,EAAEA,CADT;AAEI,MAAA,UAAU,EAAEU,IAFhB;AAGI,MAAA,QAAQ,EAAE,oBAAM;AACZxI,QAAAA,aAAa,CAACwI,IAAI,CAACN,EAAN,CAAb;AACH,OALL;AAMI,MAAA,WAAW,EAAEhI,sBANjB;AAOI,MAAA,QAAQ,EAAE,kBAACiI,QAAD,EAAc;AACpBtI,QAAAA,eAAe,CAAC,UAACuI,IAAD,EAAU;AACtB,cAAMC,KAAK,GAAGD,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC2H,MAAhC,CAAuCa,SAAvC,CAAiD,UAAA9D,IAAI;AAAA,mBAAIA,IAAI,CAAC0D,EAAL,KAAYM,IAAI,CAACN,EAArB;AAAA,WAArD,CAAd;AACAE,UAAAA,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC2H,MAAhC,CAAuCY,KAAvC,IAAgDF,QAAhD;AACH,SAHc,CAAf;AAIH,OAZL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADJ;AAgBH,GAjBA,CApDL,4BAsEKvI,YAAY,CAAC4H,UAAb,CAAwB1H,cAAxB,EAAwC2H,MAtE7C,qFAsEK,uBAAgDC,MAAhD,CAAuD,UAAAlD,IAAI;AAAA,WAAIA,IAAI,CAACmD,IAAL,KAAc,SAAlB;AAAA,GAA3D,CAtEL,2DAsEK,uBAAyFC,GAAzF,CAA6F,UAACa,OAAD,EAAUX,CAAV,EAAgB;AAC1G,WACI,MAAC,QAAD;AACI,MAAA,GAAG,EAAEA,CADT;AAEI,MAAA,UAAU,EAAEW,OAFhB;AAGI,MAAA,QAAQ,EAAE,oBAAM;AACZzI,QAAAA,aAAa,CAACyI,OAAO,CAACP,EAAT,CAAb;AACH,OALL;AAMI,MAAA,WAAW,EAAEhI,sBANjB;AAOI,MAAA,QAAQ,EAAE,kBAACiI,QAAD,EAAc;AACpBtI,QAAAA,eAAe,CAAC,UAACuI,IAAD,EAAU;AACtB,cAAMC,KAAK,GAAGD,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC2H,MAAhC,CAAuCa,SAAvC,CAAiD,UAAA9D,IAAI;AAAA,mBAAIA,IAAI,CAAC0D,EAAL,KAAYO,OAAO,CAACP,EAAxB;AAAA,WAArD,CAAd;AACAE,UAAAA,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC2H,MAAhC,CAAuCY,KAAvC,IAAgDF,QAAhD;AACH,SAHc,CAAf;AAIH,OAZL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADJ;AAgBH,GAjBA,CAtEL,4BAwFKvI,YAAY,CAAC4H,UAAb,CAAwB1H,cAAxB,EAAwC4I,IAxF7C,2DAwFK,uBAA8Cd,GAA9C,CAAkD,UAACpD,IAAD,EAAO6D,KAAP;AAAA,WAC/C,MAAC,IAAD;AACI,MAAA,GAAG,EAAEA,KADT;AAEI,MAAA,QAAQ,EAAE7D,IAFd;AAGI,MAAA,QAAQ,EAAE,oBAAM;AACZxE,QAAAA,aAAa,CAACwE,IAAI,CAAC0D,EAAN,CAAb;AACH,OALL;AAMI,MAAA,WAAW,EAAEhI,sBANjB;AAOI,MAAA,QAAQ,EAAE,kBAACyI,KAAD;AAAA,eAAW9I,eAAe,CAAC,UAACuI,IAAD,EAAU;AAC3CA,UAAAA,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC4I,IAAhC,CAAqCL,KAArC,oCACOD,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgC4I,IAAhC,CAAqCL,KAArC,CADP,GAEOO,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAeH,KAAK,CAACjE,MAAN,CAAaqE,KAA5B,CAAX,CAFP;AAIH,SALmC,CAA1B;AAAA,OAPd;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAD+C;AAAA,GAAlD,CAxFL,6BAwGKnJ,YAAY,CAAC4H,UAAb,CAAwB1H,cAAxB,EAAwCkJ,MAxG7C,4DAwGK,wBAAgDpB,GAAhD,CAAoD,UAACpD,IAAD,EAAO6D,KAAP;AAAA,WACjD,MAAC,MAAD;AACI,MAAA,GAAG,EAAEA,KADT;AAEI,MAAA,UAAU,EAAE7D,IAFhB;AAGI,MAAA,QAAQ,EAAE,oBAAM;AACZxE,QAAAA,aAAa,CAACwE,IAAI,CAAC0D,EAAN,CAAb;AACH,OALL;AAMI,MAAA,QAAQ,EAAE,kBAACS,KAAD;AAAA,eAAW9I,eAAe,CAAC,UAACuI,IAAD,EAAU;AAC3CA,UAAAA,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgCkJ,MAAhC,CAAuCX,KAAvC,oCACOD,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgCkJ,MAAhC,CAAuCX,KAAvC,CADP,GAEOO,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAeH,KAAK,CAACjE,MAAN,CAAaqE,KAA5B,CAAX,CAFP;AAIH,SALmC,CAA1B;AAAA,OANd;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADiD;AAAA,GAApD,CAxGL,6BAuHKnJ,YAAY,CAAC4H,UAAb,CAAwB1H,cAAxB,EAAwCmJ,SAvH7C,4DAuHK,wBAAmDrB,GAAnD,CAAuD,UAACpD,IAAD,EAAO6D,KAAP;AAAA,WACpD,MAAC,KAAD;AACI,MAAA,GAAG,EAAEA,KADT;AAEI,MAAA,SAAS,EAAE7D,IAFf;AAGI,MAAA,QAAQ,EAAE,oBAAM;AACZxE,QAAAA,aAAa,CAACwE,IAAI,CAAC0D,EAAN,CAAb;AACH,OALL;AAMI,MAAA,WAAW,EAAEhI,sBANjB;AAOI,MAAA,QAAQ,EAAE,kBAACyI,KAAD;AAAA,eAAW9I,eAAe,CAAC,UAACuI,IAAD,EAAU;AAC3CA,UAAAA,IAAI,CAACZ,UAAL,CAAgB1H,cAAhB,EAAgCmJ,SAAhC,CAA0CZ,KAA1C,sBAAwDM,KAAK,CAACjE,MAAN,CAAaqE,KAArE;AACH,SAFmC,CAA1B;AAAA,OAPd;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADoD;AAAA,GAAvD,CAvHL,EAoII,MAAC,oBAAD;AACI,IAAA,EAAE,cAAOhJ,UAAP,CADN;AAEI,IAAA,GAAG,EAAEO,GAFT;AAGI,IAAA,iBAAiB,EAAEP,UAHvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IApIJ,EAyII,MAAC,IAAD;AAAM,IAAA,IAAI,EAAC,mBAAX;AAA+B,IAAA,GAAG,EAAEQ,gBAApC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAzIJ,CATJ,CADJ;AAuJH,CAjgBD;;AAmgBA,eAAeZ,SAAf","sourcesContent":["import React, { useRef, useState } from 'react'\r\nimport { Stage, Layer, Rect } from 'react-konva';\r\nimport Rectangle from \"../Rectangle\"\r\nimport UCircle from \"../UCircle\"\r\nimport UPolygon from \"../UPolygon\"\r\nimport ULine from \"../ULine\"\r\nimport USvg from \"../USvg\"\r\nimport UText from \"../UText\"\r\nimport TransformerComponent from \"../UTransformer\"\r\nimport { stageDimensions } from '../../../utils/defaults';\r\nimport UImage from '../UImage';\r\n\r\ndeclare const window: any\r\n\r\nconst MainStage = ({\r\n    templateData,\r\n    setTemplateData,\r\n    variationIndex,\r\n    selectedId,\r\n    setSelectedId,\r\n    unSelectAll,\r\n    handleEditSelectedItem,\r\n}) => {\r\n\r\n    const GUIDELINE_OFFSET = 5\r\n    const $stage = useRef(null)\r\n    const $layer = useRef(null)\r\n    const $tr = useRef(null)\r\n    const selectionRectRef = useRef(null);\r\n    const selection = useRef({\r\n        visible: false,\r\n        x1: 0,\r\n        y1: 0,\r\n        x2: 0,\r\n        y2: 0\r\n    });\r\n\r\n    const [nodesArray, setNodes] = useState([]);\r\n    const Konva = window.Konva;\r\n\r\n    const getLineGuideStops = skipShape => {\r\n        const vertical: any = [0, stageDimensions.width / 2, stageDimensions.width];\r\n        const horizontal: any = [0, stageDimensions.height / 2, stageDimensions.height];\r\n\r\n        // and we snap over edges and center of each object on the canvas\r\n        $stage.current.find(\".object\").forEach(guideItem => {\r\n            if (guideItem === skipShape) {\r\n                return;\r\n            }\r\n            const box = guideItem.getClientRect();\r\n            // and we can snap to all edges of shapes\r\n            vertical.push([box.x, box.x + box.width, box.x + box.width / 2]);\r\n            horizontal.push([box.y, box.y + box.height, box.y + box.height / 2]);\r\n        });\r\n        return {\r\n            vertical: vertical.flat(),\r\n            horizontal: horizontal.flat()\r\n        };\r\n    };\r\n\r\n    const getObjectSnappingEdges = node => {\r\n        const box = node.getClientRect();\r\n\r\n        return {\r\n            vertical: [\r\n                {\r\n                    guide: Math.round(box.x),\r\n                    offset: Math.round(node.x() - box.x),\r\n                    snap: \"start\"\r\n                },\r\n                {\r\n                    guide: Math.round(box.x + box.width / 2),\r\n                    offset: Math.round(node.x() - box.x - box.width / 2),\r\n                    snap: \"center\"\r\n                },\r\n                {\r\n                    guide: Math.round(box.x + box.width),\r\n                    offset: Math.round(node.x() - box.x - box.width),\r\n                    snap: \"end\"\r\n                }\r\n            ],\r\n            horizontal: [\r\n                {\r\n                    guide: Math.round(box.y),\r\n                    offset: Math.round(node.y() - box.y),\r\n                    snap: \"start\"\r\n                },\r\n                {\r\n                    guide: Math.round(box.y + box.height / 2),\r\n                    offset: Math.round(node.y() - box.y - box.height / 2),\r\n                    snap: \"center\"\r\n                },\r\n                {\r\n                    guide: Math.round(box.y + box.height),\r\n                    offset: Math.round(node.y() - box.y - box.height),\r\n                    snap: \"end\"\r\n                }\r\n            ]\r\n        };\r\n    };\r\n\r\n    const getGuides = (lineGuideStops, itemBounds) => {\r\n        const resultV = [];\r\n        const resultH = [];\r\n\r\n        lineGuideStops.vertical.forEach(lineGuide => {\r\n            itemBounds.vertical.forEach(itemBound => {\r\n                const diff = Math.abs(lineGuide - itemBound.guide);\r\n                // if the distance between guild line and object snap point is close we can consider this for snapping\r\n                if (diff < GUIDELINE_OFFSET) {\r\n                    resultV.push({\r\n                        lineGuide: lineGuide,\r\n                        diff: diff,\r\n                        snap: itemBound.snap,\r\n                        offset: itemBound.offset\r\n                    });\r\n                }\r\n            });\r\n        });\r\n\r\n        lineGuideStops.horizontal.forEach(lineGuide => {\r\n            itemBounds.horizontal.forEach(itemBound => {\r\n                const diff = Math.abs(lineGuide - itemBound.guide);\r\n                if (diff < GUIDELINE_OFFSET) {\r\n                    resultH.push({\r\n                        lineGuide: lineGuide,\r\n                        diff: diff,\r\n                        snap: itemBound.snap,\r\n                        offset: itemBound.offset\r\n                    });\r\n                }\r\n            });\r\n        });\r\n\r\n        const guides = [];\r\n\r\n        // find closest snap\r\n        const minV = resultV.sort((a, b) => a.diff - b.diff)[0];\r\n        const minH = resultH.sort((a, b) => a.diff - b.diff)[0];\r\n        if (minV) {\r\n            guides.push({\r\n                lineGuide: minV.lineGuide,\r\n                offset: minV.offset,\r\n                orientation: \"V\",\r\n                snap: minV.snap\r\n            });\r\n        }\r\n        if (minH) {\r\n            guides.push({\r\n                lineGuide: minH.lineGuide,\r\n                offset: minH.offset,\r\n                orientation: \"H\",\r\n                snap: minH.snap\r\n            });\r\n        }\r\n        return guides;\r\n    };\r\n\r\n    const drawGuides = guides => {\r\n        guides.forEach(lg => {\r\n            if (lg.orientation === \"H\") {\r\n                const lines = new Konva.Line({\r\n                    points: [-6000, lg.lineGuide, 6000, lg.lineGuide],\r\n                    stroke: \"rgb(0, 161, 255)\",\r\n                    strokeWidth: 1,\r\n                    name: \"guid-line\",\r\n                    dash: [4, 6]\r\n                });\r\n                $layer.current.add(lines);\r\n                $layer.current.batchDraw();\r\n            } else if (lg.orientation === \"V\") {\r\n                const lines = new Konva.Line({\r\n                    points: [lg.lineGuide, -6000, lg.lineGuide, 6000],\r\n                    stroke: \"rgb(0, 161, 255)\",\r\n                    strokeWidth: 1,\r\n                    name: \"guid-line\",\r\n                    dash: [4, 6]\r\n                });\r\n                $layer.current.add(lines);\r\n                $layer.current.batchDraw();\r\n            }\r\n        });\r\n    };\r\n\r\n    const _onDragMove = e => {\r\n        const linesArray = $layer.current.find(\".guid-line\")\r\n        if (!!linesArray.length) {\r\n            linesArray.forEach(item => item.destroy())\r\n        }\r\n        const lineGuideStops = getLineGuideStops(e.target);\r\n        const itemBounds = getObjectSnappingEdges(e.target);\r\n        const guides = getGuides(lineGuideStops, itemBounds);\r\n        if (!guides.length) {\r\n            return;\r\n        }\r\n        drawGuides(guides);\r\n        guides.forEach(lg => {\r\n            switch (lg.snap) {\r\n                case \"start\": {\r\n                    switch (lg.orientation) {\r\n                        case \"V\": {\r\n                            e.target.x(lg.lineGuide + lg.offset);\r\n                            break;\r\n                        }\r\n                        case \"H\": {\r\n                            e.target.y(lg.lineGuide + lg.offset);\r\n                            break;\r\n                        }\r\n                        default:\r\n                            return;\r\n                    }\r\n                    break;\r\n                }\r\n                case \"center\": {\r\n                    switch (lg.orientation) {\r\n                        case \"V\": {\r\n                            e.target.x(lg.lineGuide + lg.offset);\r\n                            break;\r\n                        }\r\n                        case \"H\": {\r\n                            e.target.y(lg.lineGuide + lg.offset);\r\n                            break;\r\n                        }\r\n                        default:\r\n                            return;\r\n                    }\r\n                    break;\r\n                }\r\n                case \"end\": {\r\n                    switch (lg.orientation) {\r\n                        case \"V\": {\r\n                            e.target.x(lg.lineGuide + lg.offset);\r\n                            break;\r\n                        }\r\n                        case \"H\": {\r\n                            e.target.y(lg.lineGuide + lg.offset);\r\n                            break;\r\n                        }\r\n                        default:\r\n                            return;\r\n                    }\r\n                    break;\r\n                }\r\n                default:\r\n                    return;\r\n            }\r\n        });\r\n    };\r\n\r\n    const _onDragEnd = e => {\r\n        const linesArray = $layer.current.find(\".guid-line\")\r\n        if (!!linesArray.length) {\r\n            linesArray.forEach(item => item.destroy())\r\n        }\r\n        $layer.current.batchDraw();\r\n    };\r\n\r\n    const checkDeselect = (e) => {\r\n        // deselect when clicked on empty area\r\n        const clickedOnEmpty = e.target === e.target.getStage();\r\n        if (clickedOnEmpty) {\r\n            unSelectAll();\r\n            $tr.current.nodes([]);\r\n            setNodes([]);\r\n            // layerRef.current.remove(selectionRectangle);\r\n        }\r\n    };\r\n\r\n    const updateSelectionRect = () => {\r\n        const node = selectionRectRef.current;\r\n        node.setAttrs({\r\n            visible: selection.current.visible,\r\n            x: Math.min(selection.current.x1, selection.current.x2),\r\n            y: Math.min(selection.current.y1, selection.current.y2),\r\n            width: Math.abs(selection.current.x1 - selection.current.x2),\r\n            height: Math.abs(selection.current.y1 - selection.current.y2),\r\n            fill: \"rgba(0, 161, 255, 0.3)\"\r\n        });\r\n        node.getLayer().batchDraw();\r\n    };\r\n\r\n    const oldPos = React.useRef(null);\r\n    const onMouseDown = (e) => {\r\n        const isElement = e.target.findAncestor(\".elements-container\");\r\n        const isTransformer = e.target.findAncestor(\"Transformer\");\r\n        if (isElement || isTransformer) {\r\n            return;\r\n        }\r\n\r\n        const pos = e.target.getStage().getPointerPosition();\r\n        selection.current.visible = true;\r\n        selection.current.x1 = pos.x;\r\n        selection.current.y1 = pos.y;\r\n        selection.current.x2 = pos.x;\r\n        selection.current.y2 = pos.y;\r\n        updateSelectionRect();\r\n    };\r\n\r\n    const onMouseMove = (e) => {\r\n        if (!selection.current.visible) {\r\n            return;\r\n        }\r\n        const pos = e.target.getStage().getPointerPosition();\r\n        selection.current.x2 = pos.x;\r\n        selection.current.y2 = pos.y;\r\n        updateSelectionRect();\r\n    };\r\n\r\n    const onMouseUp = () => {\r\n        oldPos.current = null;\r\n        if (!selection.current.visible) {\r\n            return;\r\n        }\r\n        const selBox = selectionRectRef.current.getClientRect();\r\n\r\n        const elements = [];\r\n        $layer.current.find(\".object\").forEach((elementNode) => {\r\n            const elBox = elementNode.getClientRect();\r\n            if (Konva.Util.haveIntersection(selBox, elBox)) {\r\n                elements.push(elementNode);\r\n            }\r\n        });\r\n        $tr.current.nodes(elements);\r\n        selection.current.visible = false;\r\n        // disable click event\r\n        Konva.listenClickTap = false;\r\n        updateSelectionRect();\r\n    };\r\n\r\n    const onClickTap = (e) => {\r\n        // if we are selecting with rect, do nothing\r\n        if (selectionRectRef.current.visible()) {\r\n            return;\r\n        }\r\n        let stage = e.target.getStage();\r\n        let layer = $layer.current;\r\n        let tr = $tr.current;\r\n        // if click on empty area - remove all selections\r\n        if (e.target === stage) {\r\n            unSelectAll();\r\n            setNodes([]);\r\n            tr.nodes([]);\r\n            layer.draw();\r\n            return;\r\n        }\r\n\r\n        // do nothing if clicked NOT on our rectangles\r\n        if (!e.target.hasName(\".object\")) {\r\n            return;\r\n        }\r\n\r\n        // do we pressed shift or ctrl?\r\n        const metaPressed = e.evt.shiftKey || e.evt.ctrlKey || e.evt.metaKey;\r\n        const isSelected = tr.nodes().indexOf(e.target) >= 0;\r\n\r\n        if (!metaPressed && !isSelected) {\r\n            // if no key pressed and the node is not selected\r\n            // select just one\r\n            tr.nodes([e.target]);\r\n        } else if (metaPressed && isSelected) {\r\n            // if we pressed keys and node was selected\r\n            // we need to remove it from selection:\r\n            const nodes = tr.nodes().slice(); // use slice to have new copy of array\r\n            // remove node from array\r\n            nodes.splice(nodes.indexOf(e.target), 1);\r\n            tr.nodes(nodes);\r\n        } else if (metaPressed && !isSelected) {\r\n            // add the node into selection\r\n            const nodes = tr.nodes().concat([e.target]);\r\n            tr.nodes(nodes);\r\n        }\r\n        layer.draw();\r\n    };\r\n\r\n    console.log({ variation: templateData.variations[variationIndex] })\r\n\r\n    return (\r\n        <Stage\r\n            ref={$stage}\r\n            onMouseDown={onMouseDown}\r\n            onMouseUp={onMouseUp}\r\n            onMouseMove={onMouseMove}\r\n            onTouchStart={checkDeselect}\r\n            onClick={onClickTap}\r\n            {...stageDimensions}\r\n        >\r\n            <Layer\r\n                ref={$layer}\r\n                onDragMove={_onDragMove}\r\n                onDragEnd={_onDragEnd}\r\n            >\r\n                {templateData.variations[variationIndex].shapes?.filter(item => item.type === \"rectangle\")?.map((rect, i) => {\r\n                    return (\r\n                        <Rectangle\r\n                            key={i}\r\n                            shapeProps={rect}\r\n                            onSelect={(e) => {\r\n                                if (e.current !== undefined) {\r\n                                    let temp = nodesArray;\r\n                                    if (!nodesArray.includes(e.current)) temp.push(e.current);\r\n                                    setNodes(temp);\r\n                                    $tr.current.nodes(nodesArray);\r\n                                    $tr.current.nodes(nodesArray);\r\n                                    $tr.current.getLayer().batchDraw();\r\n                                }\r\n                                setSelectedId(rect.id);\r\n                            }}\r\n                            // onSelect={() => {\r\n                            //     setSelectedId(rect.id)\r\n                            // }}\r\n                            onEditClick={handleEditSelectedItem}\r\n                            onChange={(newAttrs) => {\r\n                                setTemplateData((prev) => {\r\n                                    const index = prev.variations[variationIndex].shapes.findIndex(item => item.id === rect.id)\r\n                                    prev.variations[variationIndex].shapes[index] = newAttrs\r\n                                });\r\n                            }}\r\n                        />\r\n                    );\r\n                })}\r\n                {templateData.variations[variationIndex].shapes?.filter(item => item.type === \"circle\")?.map((circle, i) => {\r\n                    return (\r\n                        <UCircle\r\n                            key={i}\r\n                            shapeProps={circle}\r\n                            onSelect={() => {\r\n                                setSelectedId(circle.id)\r\n                            }}\r\n                            onEditClick={handleEditSelectedItem}\r\n                            onChange={(newAttrs) => {\r\n                                setTemplateData((prev) => {\r\n                                    const index = prev.variations[variationIndex].shapes.findIndex(item => item.id === circle.id)\r\n                                    prev.variations[variationIndex].shapes[index] = newAttrs\r\n                                });\r\n                            }}\r\n                        />\r\n                    );\r\n                })}\r\n                {templateData.variations[variationIndex].shapes?.filter(item => item.type === \"line\")?.map((line, i) => {\r\n                    return (\r\n                        <ULine\r\n                            key={i}\r\n                            shapeProps={line}\r\n                            onSelect={() => {\r\n                                setSelectedId(line.id)\r\n                            }}\r\n                            onEditClick={handleEditSelectedItem}\r\n                            onChange={(newAttrs) => {\r\n                                setTemplateData((prev) => {\r\n                                    const index = prev.variations[variationIndex].shapes.findIndex(item => item.id === line.id)\r\n                                    prev.variations[variationIndex].shapes[index] = newAttrs\r\n                                });\r\n                            }}\r\n                        />\r\n                    );\r\n                })}\r\n                {templateData.variations[variationIndex].shapes?.filter(item => item.type === \"polygon\")?.map((polygon, i) => {\r\n                    return (\r\n                        <UPolygon\r\n                            key={i}\r\n                            shapeProps={polygon}\r\n                            onSelect={() => {\r\n                                setSelectedId(polygon.id)\r\n                            }}\r\n                            onEditClick={handleEditSelectedItem}\r\n                            onChange={(newAttrs) => {\r\n                                setTemplateData((prev) => {\r\n                                    const index = prev.variations[variationIndex].shapes.findIndex(item => item.id === polygon.id)\r\n                                    prev.variations[variationIndex].shapes[index] = newAttrs\r\n                                });\r\n                            }}\r\n                        />\r\n                    );\r\n                })}\r\n                {templateData.variations[variationIndex].svgs?.map((item, index) => (\r\n                    <USvg\r\n                        key={index}\r\n                        svgProps={item}\r\n                        onSelect={() => {\r\n                            setSelectedId(item.id)\r\n                        }}\r\n                        onEditClick={handleEditSelectedItem}\r\n                        onChange={(event) => setTemplateData((prev) => {\r\n                            prev.variations[variationIndex].svgs[index] = {\r\n                                ...prev.variations[variationIndex].svgs[index],\r\n                                ...JSON.parse(JSON.stringify(event.target.attrs))\r\n                            }\r\n                        })}\r\n                    />\r\n                ))}\r\n                {templateData.variations[variationIndex].images?.map((item, index) => (\r\n                    <UImage\r\n                        key={index}\r\n                        imageProps={item}\r\n                        onSelect={() => {\r\n                            setSelectedId(item.id)\r\n                        }}\r\n                        onChange={(event) => setTemplateData((prev) => {\r\n                            prev.variations[variationIndex].images[index] = {\r\n                                ...prev.variations[variationIndex].images[index],\r\n                                ...JSON.parse(JSON.stringify(event.target.attrs))\r\n                            }\r\n                        })}\r\n                    />\r\n                ))}\r\n                {templateData.variations[variationIndex].textBoxes?.map((item, index) => (\r\n                    <UText\r\n                        key={index}\r\n                        textProps={item}\r\n                        onSelect={() => {\r\n                            setSelectedId(item.id)\r\n                        }}\r\n                        onEditClick={handleEditSelectedItem}\r\n                        onChange={(event) => setTemplateData((prev) => {\r\n                            prev.variations[variationIndex].textBoxes[index] = { ...event.target.attrs }\r\n                        })}\r\n                    />\r\n                ))}\r\n                <TransformerComponent\r\n                    id={`tr${selectedId}`}\r\n                    $tr={$tr}\r\n                    selectedShapeName={selectedId}\r\n                />\r\n                <Rect fill=\"rgba(0,0,255,0.5)\" ref={selectionRectRef} />\r\n            </Layer>\r\n        </Stage>\r\n    )\r\n}\r\n\r\nexport default MainStage\r\n"]},"metadata":{},"sourceType":"module"}